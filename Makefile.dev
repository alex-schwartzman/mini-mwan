# Development Makefile for mini-mwan
# Provides convenient targets for building in Docker

.PHONY: build rebuild clean-soft clean-hard shell help

# Build both packages
build:
	docker-compose run --rm openwrt-sdk bash -c "\
		[ ! -f .config ] && make defconfig || true && \
		make package/mini-mwan/compile && \
		make package/luci-app-mini-mwan/compile && \
		echo '' && \
		echo '=== Packages Built ===' && \
		ls -lh bin/packages/x86_64/base/mini-mwan*.ipk bin/packages/x86_64/base/luci-app-mini-mwan*.ipk 2>/dev/null || true"

# Soft clean: remove only mini-mwan build artifacts, keep .config
clean-soft:
	docker-compose run --rm openwrt-sdk bash -c "\
		rm -rf build_dir/target-*/mini-mwan* build_dir/target-*/luci-app-mini-mwan* && \
		rm -rf bin/packages/*/base/mini-mwan* bin/packages/*/base/luci-app-mini-mwan*"

# Rebuild: alias for rebuild-hard
# NOTE: .config is not mounted as a file because Docker creates directories for non-existent paths,
# causing build failures when OpenWrt expects a file. Therefore, configuration will always remain
# ephemeral, at least until the moment when I figure out how to work it around.
rebuild: rebuild-hard

# Hard clean: remove everything including .config (requires defconfig after)
clean-hard:
	docker-compose run --rm openwrt-sdk bash -c "\
		rm -rf build_dir/target-*/mini-mwan* && \
		rm -rf bin/packages/*/base/mini-mwan* && \
		rm -f .config"

# Full rebuild from scratch (both packages)
rebuild-hard:
	docker-compose run --rm openwrt-sdk bash -c "\
		make defconfig && \
		rm -rf build_dir/target-*/mini-mwan* build_dir/target-*/luci-app-mini-mwan* bin/packages/*/base/mini-mwan* bin/packages/*/base/luci-app-mini-mwan* && \
		make package/mini-mwan/compile && \
		make package/luci-app-mini-mwan/compile && \
		echo '' && \
		echo '=== Packages Built ===' && \
		ls -lh bin/packages/x86_64/base/mini-mwan*.ipk bin/packages/x86_64/base/luci-app-mini-mwan*.ipk 2>/dev/null || echo 'Check build logs for errors'"

# Open a shell in the build container
shell:
	docker-compose run --rm openwrt-sdk bash

# Update feeds from local repos (offline)
feeds-update:
	docker-compose run --rm openwrt-sdk scripts/feeds update -i -a

# Install all feeds
feeds-install:
	docker-compose run --rm openwrt-sdk scripts/feeds install -a

# Show help
help:
	@echo "Mini-MWAN Development Makefile"
	@echo ""
	@echo "Available targets:"
	@echo "  build          - Build both packages (mini-mwan + luci-app-mini-mwan)"
	@echo "  rebuild        - Alias for rebuild-hard"
	@echo "  clean-soft     - Remove only build artifacts (keeps .config)"
	@echo "  clean-hard     - Remove build artifacts and .config"
	@echo "  rebuild-hard   - Full rebuild from defconfig (both packages)"
	@echo "  shell          - Open shell in build container"
	@echo "  feeds-update   - Update feeds index (offline mode)"
	@echo "  feeds-install  - Install all feeds"
	@echo "  help           - Show this help message"
	@echo ""
	@echo "Quick workflow:"
	@echo "  make -f Makefile.dev build   # Build both packages after code changes"
